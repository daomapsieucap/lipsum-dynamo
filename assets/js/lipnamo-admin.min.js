(t=>{window.LipnamoMediaUploader=window.LipnamoMediaUploader||{};class e{constructor(){this.prefix="lipnamo",this.selectors={imageInput:'.lipnamo-input__img input[type="text"]',uploadBtn:".lipnamo-upload",previewList:".lipnamo-preview__list",thumbnailsInput:"#lipnamo-thumbnails",removeThumbnail:".lipnamo-remove-thumbnail"},this.mediaUploaders=new Map,this.init()}init(){if(this.validateEnvironment())try{this.lipnamo_initImagePreview(),this.lipnamo_initMediaUploader(),this.lipnamo_initThumbnailRemoval()}catch(e){console.log("Error initializing upload handlers: "+e.message,"error")}else console.log("Media uploader functionality disabled - WordPress media library not found","warn")}validateEnvironment(){return"undefined"!=typeof wp&&void 0!==wp.media&&"undefined"!=typeof jQuery}lipnamo_initImagePreview(){t(document).on("change.lipnamo",this.selectors.imageInput,function(){var e=t(this);e.closest("fieldset").find("img").toggle(!!e.val())})}lipnamo_initMediaUploader(){let a=this;t(document).on("click.lipnamo",this.selectors.uploadBtn,function(e){e.preventDefault();var e=t(this),i=e.data("lipnamo-uploader-id")||a.lipnamo_generateUploaderId();e.data("lipnamo-uploader-id",i),a.lipnamo_handleUploaderClick(e,i)})}lipnamo_generateUploaderId(){return`${this.prefix}_uploader_${Date.now()}_`+Math.random().toString(36).substr(2,9)}lipnamo_handleUploaderClick(e,i){var e=e.closest("fieldset").find(this.selectors.previewList),a=t(this.selectors.thumbnailsInput);(this.mediaUploaders.has(i)?this.mediaUploaders.get(i):(a=this.lipnamo_createMediaUploader(a,e),this.mediaUploaders.set(i,a),a)).open()}lipnamo_createMediaUploader(e,i){let a=this;this.prefix,Date.now();let n=wp.media({title:"Choose Images - Lipnamo",button:{text:"Choose Images"},multiple:"add",library:{type:"image"}});return n.on("select",function(){a.lipnamo_handleFileSelection(n,e,i)}),n.on("open",function(){a.lipnamo_handleUploaderOpen(n,e)}),n}lipnamo_handleFileSelection(e,t,l){e=e.state().get("selection").toJSON();if(e&&0!==e.length){let i=this.lipnamo_getCurrentThumbnailIds(t),a=[],n=[];e.forEach(e=>{i.includes(e.id)||(a.push(e.id),n.push(this.lipnamo_createPreviewItem(e)))}),0<a.length&&(this.lipnamo_updateThumbnailIds(t,i.concat(a)),l.append(n.join("")))}}lipnamo_handleUploaderOpen(e,i){let a=e.state().get("selection");this.lipnamo_getCurrentThumbnailIds(i).forEach(e=>{e&&((e=wp.media.attachment(e)).fetch(),a.add(e))})}lipnamo_getCurrentThumbnailIds(e){e=e.val().trim();return e?e.split(",").map(e=>parseInt(e.trim())).filter(e=>!isNaN(e)&&0<e):[]}lipnamo_updateThumbnailIds(e,i){i=[...new Set(i)].filter(e=>e&&!isNaN(e)&&0<e);e.val(i.join(",")),e.trigger("change.lipnamo")}lipnamo_createPreviewItem(e){var i=this.lipnamo_sanitizeUrl(e.sizes.medium.url||""),a=this.lipnamo_sanitizeText(e.alt||e.title||"Selected image"),e=parseInt(e.id);return`<li class="lipnamo-preview-item attachment" data-lipnamo-id="${e}">
                        <div class="attachment-preview">
                            <div class="thumbnail">
                                <div class="centered">
                                    <img src="${i}" alt="${a}" class="lipnamo-preview-image" />
                                </div>
                            </div>
                            <button type="button" 
                                    class="lipnamo-remove-thumbnail button-link attachment-close media-modal-icon" 
                                    data-lipnamo-id="${e}" 
                                    title="Remove image"
                                    aria-label="Remove image">
                                    <span class="screen-reader-text">Remove</span>
                            </button>
                        </div>
                    </li>`}lipnamo_initThumbnailRemoval(){let n=this;t(document).on("click.lipnamo",this.selectors.removeThumbnail,function(e){e.preventDefault();var e=t(this),i=parseInt(e.data("lipnamo-id")),a=t(n.selectors.thumbnailsInput),e=e.closest(".lipnamo-preview-item");i&&e.length&&n.lipnamo_removeThumbnail(i,a,e)})}lipnamo_removeThumbnail(i,e,a){var n=this.lipnamo_getCurrentThumbnailIds(e).filter(e=>e!==i);this.lipnamo_updateThumbnailIds(e,n),a.fadeOut(300,function(){t(this).remove()})}lipnamo_sanitizeUrl(e){return"string"!=typeof e?"":e.replace(/[<>"']/g,"")}lipnamo_sanitizeText(e){return"string"!=typeof e?"":e.replace(/[<>"'&]/g,function(e){return{"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","&":"&amp;"}[e]||e})}lipnamo_destroy(){t(document).off(".lipnamo"),this.mediaUploaders.clear()}lipnamo_refresh(){this.lipnamo_destroy(),this.init()}}t(document).ready(function(){window.lipnamoMediaUploaderInstance||(window.lipnamoMediaUploaderInstance=new e,window.LipnamoMediaUploader.refresh=function(){window.lipnamoMediaUploaderInstance&&window.lipnamoMediaUploaderInstance.lipnamo_refresh()},window.LipnamoMediaUploader.destroy=function(){window.lipnamoMediaUploaderInstance&&(window.lipnamoMediaUploaderInstance.lipnamo_destroy(),window.lipnamoMediaUploaderInstance=null)})})})(jQuery);