class LipnamoCleanupManager{constructor(){this.currentStep=1,this.isRunning=!1,this.config={},this.elements={},this.init()}init(){this.cacheElements(),this.bindEvents()}cacheElements(){this.elements={wpBody:document.getElementById("wpbody"),cleanupButton:document.querySelector(".lipnamo-cleanup.button"),progressBar:document.querySelector(".lipnamo-progress-bar"),progressWrapper:document.querySelector(".lipnamo-progress-wrapper"),progressStep:document.querySelector(".lipnamo-progress-step"),progressTotal:document.querySelector(".lipnamo-progress-total"),progressText:document.querySelector(".lipnamo-progress-text"),stepInput:document.querySelector('input[name="lipnamo-cleanup__step"]'),postTotalInput:document.querySelector('input[name="lipnamo_post_total"]'),postTypeSelect:document.querySelector('select[name="lipnamo_post_type"]')}}bindEvents(){this.elements.postTypeSelect&&this.elements.postTypeSelect.addEventListener("change",()=>{this.updatePostTotal()}),this.elements.cleanupButton&&this.elements.cleanupButton.addEventListener("click",e=>{e.preventDefault(),this.startCleanup()})}async updatePostTotal(){var e=this.elements.postTypeSelect?.value||"";this.showLoading(),this.disableCleanupButton();try{var t=new FormData,s=(t.append("action","lipnamo_total_items"),t.append("lipnamo_ajax_nonce",lipnamo_items.ajax_nonce),t.append("post_type",e),await fetch(lipnamo_items.ajax_url,{method:"POST",body:t,credentials:"same-origin"}));if(!s.ok)throw new Error("HTTP error! status: "+s.status);var n=await s.text(),o=JSON.parse(n),a=parseInt(o.post_total)||0;this.elements.postTotalInput&&(this.elements.postTotalInput.value=a)}catch(e){console.error("LipnamoCleanupManager: Error updating post total",e)}finally{this.hideLoading(),this.enableCleanupButton()}}startCleanup(){this.isRunning||(this.config=this.getCleanupConfig(),this.currentStep=1,this.isRunning=!0,this.showProgress(),this.elements.progressTotal&&(this.elements.progressTotal.textContent=this.config.postTotal),this.lipnamoCleanupItems())}getCleanupConfig(){return{postTotal:parseInt(this.elements.postTotalInput?.value)||0,postType:this.elements.postTypeSelect?.value||""}}showLoading(){this.elements.wpBody&&this.elements.wpBody.classList.add("lipnamo-loading")}hideLoading(){this.elements.wpBody&&this.elements.wpBody.classList.remove("lipnamo-loading")}showProgress(){this.showLoading(),this.elements.progressWrapper&&(this.elements.progressWrapper.style.display="block"),this.disableCleanupButton()}hideProgress(){this.hideLoading(),this.enableCleanupButton(),this.isRunning=!1}disableCleanupButton(){this.elements.cleanupButton&&this.elements.cleanupButton.classList.add("disabled")}enableCleanupButton(){this.elements.cleanupButton&&this.elements.cleanupButton.classList.remove("disabled")}updateProgress(e,t){t=Math.min(100*e/t,100);this.elements.progressStep&&(this.elements.progressStep.textContent=e),this.elements.stepInput&&(this.elements.stepInput.value=e),this.elements.progressBar&&this.animateProgressBar(t)}animateProgressBar(e){let s=this.elements.progressBar,n=parseFloat(s.style.width)||0,o=e,a=150,r=performance.now(),i=e=>{var e=e-r,e=Math.min(e/a,1),t=1-Math.pow(1-e,3),t=n+(o-n)*t;s.style.width=t+"%",e<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}async lipnamoCleanupItems(){if(this.currentStep>this.config.postTotal)this.hideProgress();else try{var e=new FormData,t=(e.append("action","lipnamo_cleanup_items"),e.append("lipnamo_ajax_nonce",lipnamo_items.ajax_nonce),e.append("post_total",this.config.postTotal),e.append("post_type",this.config.postType),e.append("post_step",this.currentStep),await fetch(lipnamo_items.ajax_url,{method:"POST",body:e,credentials:"same-origin"}));if(!t.ok)throw new Error("HTTP error! status: "+t.status);var s=await t.text();await this.handleSuccess(s)}catch(e){this.handleError(e)}}async handleSuccess(e){try{var t=JSON.parse(e),s=parseInt(t.step)||this.currentStep;this.updateProgress(s,this.config.postTotal),s>=this.config.postTotal?(this.elements.progressText&&(this.elements.progressText.textContent=t.message||"Cleanup completed!"),this.hideProgress()):(this.currentStep=s+1,setTimeout(()=>{this.isRunning&&this.lipnamoCleanupItems()},100))}catch(e){console.error("LipnamoCleanupManager: Error parsing response",e),this.handleError(e)}}handleError(e){console.error("LipnamoCleanupManager: Error",e),this.elements.progressText&&(this.elements.progressText.textContent="An error occurred during cleanup. Please try again."),this.hideProgress()}stop(){this.isRunning=!1,this.hideProgress()}reset(){this.stop(),this.currentStep=1,this.elements.progressBar&&(this.elements.progressBar.style.width="0%"),this.elements.progressStep&&(this.elements.progressStep.textContent="0"),this.elements.progressText&&(this.elements.progressText.textContent=""),this.elements.stepInput&&(this.elements.stepInput.value="")}getStatus(){return{isRunning:this.isRunning,currentStep:this.currentStep,totalSteps:this.config.postTotal,postType:this.config.postType}}}document.addEventListener("DOMContentLoaded",function(){new LipnamoCleanupManager});